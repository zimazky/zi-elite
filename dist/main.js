(()=>{"use strict";var t={752:(t,e,i)=>{const s=i(331),r=i(764),a=i(115),h=i(490),n=i(421),o=i(100),l=i(704),u=i(385),g=i(270),c=i(193),m=i(237),d=i(386),f=i(9),p=i(460);e.Z=async function(){const t=document.getElementById("info"),e=new a.Engine("glcanvas");let i=0,M=0;(0,n.initKeyBuffer)();const E=await(0,p.loadImage)("textures/gray_noise.png"),y=await(0,p.loadImage)("textures/blue_noise.png"),R=await(0,p.loadImage)("textures/starmap_2020_16k_gal.jpg"),T=await(0,p.loadImage)("textures/constellation_figures_8k_gal.jpg"),x=new g.TerrainSampler(new o.NoiseSampler(E)),b=localStorage.getItem("ziEliteData")??"{}";console.log("localStorage",b),JSON.parse(b);let w=new c.Vec3(2316,0,7696),A=new l.Quaternion(0,-.9908125427905498,0,.13524239368232574);const _=new r.Camera(w,A,x),S=new s.Atmosphere,v=new u.Sky(_,S),P=new h.Flare(_),D=new h.Flare(_),U=await e.addFramebufferMRT(2195,1131,1,"shaders","a/vs.glsl","a/fs.glsl",(t=>{L.init(t)}),((t,e)=>{L.update()})),I=await e.addFramebufferMRT(2195,1131,3,"shaders","b/vs.glsl","b/fs.glsl",(t=>{F.init(t,E)}),((t,e)=>{F.update(t,e)})),L=new m.ProgramA(e,I,_),F=new d.ProgramB(e,U,_,S),C=new f.ProgramRender(e,U,I,_,S,v,P,D);await e.setRenderbuffer("shaders","render1/vs.glsl","render1/fs.glsl",(t=>{C.init(t,y,R,T,E)}),((t,e)=>{C.update(t,e)})),e.onUpdate=(s,r)=>{if(_.loopCalculation(s,r),v.loopCalculation(s,r),P.update(s,r),D.update(s,r),s>i){const a=1e3*r,h=_.velocity.length(),n=3.6*h,o=e.canvas.width.toFixed(0),l=e.canvas.height.toFixed(0);t.innerText=`dt: ${a.toFixed(2)} fps: ${(1e3/a).toFixed(2)} ${o}x${l}\n      v: ${h.toFixed(2)}m/s (${n.toFixed(2)}km/h)\n      alt: ${_.altitude.toFixed(2)} h: ${_.position.y.toFixed(2)}\n      x: ${_.position.x.toFixed(2)} y: ${_.position.z.toFixed(2)}`,i=s+.5}if(s>M){const t=JSON.stringify({position:_.position,orientation:_.orientation});localStorage.setItem("ziEliteData",t),M=s+5}},e.start()}},331:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.Atmosphere=void 0;const s=i(24),r=i(921),a=i(193),h=Math.PI*Math.PI*Math.PI,n=1.04345246,o=1/(4*Math.PI);e.Atmosphere=class{constructor(){this.planetRadius=6371e3,this.planetCenter=new a.Vec3(0,-this.planetRadius,0),this.radius=6471e3,this.n=1.00029,this.rgbLambda=new a.Vec3(615e-9,535e-9,445e-9),this.betaRayleigh=new a.Vec3(55e-7,13e-6,224e-7),this.betaMie=a.Vec3.ONE().mulMutable(2e-7),this.g=.996,this.p=.035,this.heightRayleigh=8e3,this.heightMie=1200,this.planetRadius2=this.planetRadius*this.planetRadius,this.radius2=this.radius*this.radius}computeBetaRayleigh(t){const e=this.n*this.n-1,i=t*t;return 8*h*e*e*(6+3*this.p)/(7512000000000001e10*i*i*(6-7*this.p))}ChHOld(t,e,i){const s=t+e,r=n*Math.sqrt(s),a=r*Math.exp(-e);if(i>=0)return a/(r*i+1);{const e=Math.sqrt(1-i*i)*s;return n*Math.sqrt(e)*2*Math.exp(t-e)-a/(1-r*i)}}ChH(t,e,i){const s=t+e,r=n*Math.sqrt(s),a=r*Math.exp(-e);if(i>=0)return a/((r-1)*i+1);{const e=Math.sqrt(1-i*i);return a/((r-1)*i-1)+2*r*Math.exp(t-s*e)*Math.sqrt(e)}}softPlanetShadow(t,e){const i=t.sub(this.planetCenter),a=i.dot(e),h=Math.sqrt(i.dot(i)-a*a);if(a>0)return 1;const n=(this.planetRadius-h)/a;return(0,r.smoothstep)(-s.SUN_DISC_ANGLE_SIN,s.SUN_DISC_ANGLE_SIN,n)}scattering(t,e,i){const s=t.sub(this.planetCenter);let r=s.dot(s),h=-s.dot(e);const n=r-h*h;if(n>=this.radius2)return{t:a.Vec3.ZERO(),i:a.Vec3.ONE()};const l=Math.sqrt(this.radius2-n);let u=2*l;if(r>this.radius2){if(h<0)return{t:a.Vec3.ZERO(),i:a.Vec3.ONE()};s.addMutable(e.mul(h-l)),r=this.radius2,h=l}else u=l-s.dot(e);let g=!1;s.normalize().dot(e)<0&&n<this.planetRadius2&&(u=h-Math.sqrt(this.planetRadius2-n),g=!0);const c=e.dot(i),m=c*c,d=this.g*this.g,f=.75*(1+m)*o,p=1.5*(1-d)/(2+d)*(1+m)/Math.pow(1+d-2*c*this.g,1.5)*o,M=u/32,E=e.mul(M),y=s.add(E),R=s.add(E.mul(.5));let T=0,x=0;const b=a.Vec3.ZERO(),w=a.Vec3.ZERO();let A=M*Math.exp(-(s.length()-this.planetRadius)/this.heightRayleigh),_=M*Math.exp(-(s.length()-this.planetRadius)/this.heightMie);for(let t=0;t<32;t++,y.addMutable(E),R.addMutable(E)){const t=y.length()-this.planetRadius,e=M*Math.exp(-t/this.heightRayleigh),s=M*Math.exp(-t/this.heightMie);T+=.5*(e+A),x+=.5*(s+_),A=e,_=s;const r=R.dot(i),a=R.dot(R)-r*r;if(r>0||a>this.planetRadius2){const t=R.normalize().dot(i),r=R.length()-this.planetRadius,a=this.heightRayleigh*this.ChH(this.planetRadius/this.heightRayleigh,r/this.heightRayleigh,t),h=this.heightMie*this.ChH(this.planetRadius/this.heightMie,r/this.heightMie,t),n=this.betaRayleigh.mul(-T-a).addMutable(this.betaMie.mul(-x-h)).exp();b.addMutable(n.mul(e)),w.addMutable(n.mul(s))}}const S=g?this.betaRayleigh.mul(-T).exp():this.betaRayleigh.mul(-T).addMutable(this.betaMie.mul(-x)).exp();return{t:this.betaRayleigh.mulEl(b).mulMutable(f).addMutable(this.betaMie.mulEl(w).mulMutable(p)),i:S}}transmittance(t,e){const i=t.sub(this.planetCenter);let s=i.dot(i),r=-i.dot(e);const h=s-r*r;if(h>=this.radius2)return a.Vec3.ZERO();const n=Math.sqrt(this.radius2-h);let l=2*n;if(s>this.radius2){if(r<0)return a.Vec3.ZERO();i.addMutable(e.mul(r-n)),s=this.radius2,r=n}else l=n-i.dot(e);let u=!1;i.normalize().dot(e)<0&&h<this.planetRadius2&&(l=r-Math.sqrt(this.planetRadius2-h));const g=this.g*this.g,c=1.5*o,m=1.5*(1-g)/(2+g)*2/Math.pow(1+g-2*this.g,1.5)*o,d=l/32,f=e.mul(d),p=i.add(f),M=i.add(f.mul(.5));let E=0,y=0;const R=a.Vec3.ZERO(),T=a.Vec3.ZERO();let x=d*Math.exp(-(i.length()-this.planetRadius)/this.heightRayleigh),b=d*Math.exp(-(i.length()-this.planetRadius)/this.heightMie);for(let t=0;t<32;t++,p.addMutable(f),M.addMutable(f)){const t=p.length()-this.planetRadius,e=d*Math.exp(-t/this.heightRayleigh),i=d*Math.exp(-t/this.heightMie);E+=.5*(e+x),y+=.5*(i+b),x=e,b=i;const s=this.betaRayleigh.mul(-E).addMutable(this.betaMie.mul(-y)).exp();R.addMutable(s.mul(e)),T.addMutable(s.mul(i))}return this.betaRayleigh.mulEl(R).mulMutable(c).addMutable(this.betaMie.mulEl(T).mulMutable(m))}}},764:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.Camera=e.MAP_VIEW=e.FRONT_VIEW=void 0;const s=i(421),r=i(704),a=i(193);e.FRONT_VIEW=0,e.MAP_VIEW=1;const h=new a.Vec3(.01,.05,.001).mulMutable(58),n=Math.PI/180;e.Camera=class{constructor(t,e,i){this.direction=new a.Vec3(0,0,-1),this.transformMat=a.Mat3.ID(),this.transformMatPrev=a.Mat3.ID(),this.positionDelta=a.Vec3.ZERO(),this.headLights=0,this.position=t.copy(),this.velocity=a.Vec3.ZERO(),this.angularSpeed=a.Vec3.ZERO(),this.orientation=e,this.viewAngle=80*Math.PI/180,this.tSampler=i,this.screenMode=0,this.mapMode=0,this.mapScale=5e3}inShadow(t,e,i){const s=t.softPlanetShadow(e,i);if(s<=.001)return 0;const r=s*this.tSampler.softShadow(this.position,i);return Math.pow(r,4)}loopCalculation(t,i){const o=new a.Vec3(0,0,(0,s.isKeyDown)(83)-(0,s.isKeyDown)(87));this.transformMatPrev=this.transformMat;const l=this.orientation.mat3();this.transformMat=l,this.velocity.addMutable(l.mul(o).mulMutable(11*i)),this.velocity.subMutable(l.mul(l.mulLeft(this.velocity).mulElMutable(h)).mulMutable(i)),this.velocity.y-=0*i,(0,s.isKeyDown)(32)>0&&(this.velocity=a.Vec3.ZERO()),this.positionDelta=this.position.copy(),this.position.addMutable(this.velocity.mul(i));const u=this.tSampler.terrainM(new a.Vec2(this.position.x,this.position.z))+2;this.position.y<u&&(this.velocity.y=0,this.position.y=u),this.positionDelta=this.position.sub(this.positionDelta),this.altitude=this.position.y-u;const g=new a.Vec3((0,s.isKeyDown)(40)-(0,s.isKeyDown)(38),(0,s.isKeyDown)(188)-(0,s.isKeyDown)(190),2*((0,s.isKeyDown)(37)-(0,s.isKeyDown)(39)));this.angularSpeed.addMutable(g.mulMutable(3*n*i)),this.angularSpeed.subMutable(this.angularSpeed.mul(3*i));const c=this.angularSpeed.mul(20*i);this.orientation=this.orientation.qmul(new r.Quaternion(0,0,Math.sin(c.z),Math.cos(c.z))),this.orientation=this.orientation.qmul(new r.Quaternion(Math.sin(c.x),0,0,Math.cos(c.x))),this.orientation=this.orientation.qmul(new r.Quaternion(0,Math.sin(c.y),0,Math.cos(c.y))),this.orientation.normalizeMutable(),this.direction=this.orientation.rotate(new a.Vec3(0,0,-1)),(0,s.isKeyPress)(77)>0&&(this.screenMode=this.screenMode==e.FRONT_VIEW?e.MAP_VIEW:e.FRONT_VIEW),this.screenMode==e.MAP_VIEW?(this.mapScale*=1+.01*((0,s.isKeyDown)(109)+(0,s.isKeyDown)(189)-(0,s.isKeyDown)(107)-(0,s.isKeyDown)(187)),(0,s.isKeyPress)(71)>0&&(this.mapMode^=1),(0,s.isKeyPress)(72)>0&&(this.mapMode^=2)):this.viewAngle+=.01*((0,s.isKeyDown)(109)-(0,s.isKeyDown)(107)),(0,s.isKeyPress)(76)>0&&(this.headLights=0==this.headLights?100:0)}}},24:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.SUN_COLOR=e.SUN_DISC_ANGLE_SIN=void 0;const s=i(193);e.SUN_DISC_ANGLE_SIN=.008725,e.SUN_COLOR=s.Vec3.ONE()},115:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.Engine=void 0;const s=i(318),r=i(240);class a extends s.GLContext{constructor(t){super(t),this.textures=[],this.framebuffers=[],this.onUpdate=(t,e)=>{}}async addFramebufferMRT(t,e,i,s,a,h,n=(t=>{}),o=((t,e)=>{})){const l=(0,r.preprocess)(s,a),u=(0,r.preprocess)(s,h),g=this.createProgram(await l,await u),[c,m]=this.createFramebufferMRT(t,e,i);this.gl.useProgram(g);const d=this.gl.getUniformLocation(g,"uResolution"),f=this.gl.getUniformLocation(g,"uTime");return this.framebuffers.push({width:t,height:e,program:g,framebuffer:c,fbTextures:m,vertexArray:null,numOfVertices:4,isElementDraw:!1,isDepthTest:!1,clearColor:null,resolutionLocation:d,timeLocation:f,onProgramInit:n,onProgramLoop:o}),this.framebuffers[this.framebuffers.length-1]}async setRenderbuffer(t,e,i,s=(t=>{}),a=((t,e)=>{})){const h=(0,r.preprocess)(t,e),n=(0,r.preprocess)(t,i),o=this.createProgram(await h,await n);this.gl.useProgram(o);const l=this.gl.getUniformLocation(o,"uResolution"),u=this.gl.getUniformLocation(o,"uTime");this.renderbufer={program:o,vertexArray:null,numOfVertices:4,isElementDraw:!1,isDepthTest:!1,clearColor:null,resolutionLocation:l,timeLocation:u,onProgramInit:s,onProgramLoop:a}}async loadShader(t){let e=await fetch(t);return await e.text()}setVertexArray(t,e,i,s,r=2){t.vertexArray=this.gl.createVertexArray(),t.numOfVertices=i.length/r,this.gl.bindVertexArray(t.vertexArray);const a=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,a),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array(i),this.gl.STATIC_DRAW);const h=this.gl.getAttribLocation(t.program,e);if(this.gl.enableVertexAttribArray(h),this.gl.vertexAttribPointer(h,r,this.gl.FLOAT,!1,0,0),null===s)return;t.isElementDraw=!0,t.numOfVertices=s.length;const n=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ELEMENT_ARRAY_BUFFER,n),this.gl.bufferData(this.gl.ELEMENT_ARRAY_BUFFER,new Uint32Array(s),this.gl.STATIC_DRAW)}setRenderedTexture(t,e,i){const s=this.gl.getUniformLocation(t,i);let r=this.textures.findIndex((t=>t==e));-1===r&&(r=this.textures.length,this.textures.push(e)),this.gl.uniform1i(s,r),this.gl.activeTexture(this.gl.TEXTURE0+r),this.gl.bindTexture(this.gl.TEXTURE_2D,e)}resizeCanvasToDisplaySize(){if(void 0===this.canvas)return;const t=window.innerWidth,e=window.innerHeight;this.canvas.width===t&&this.canvas.height===e||(this.canvas.width=t,this.canvas.height=e,this.gl.viewport(0,0,this.canvas.width,this.canvas.height))}setTexture(t,e,i){const s=this.gl.createTexture(),r=this.textures.length;this.gl.activeTexture(this.gl.TEXTURE0+r),this.gl.bindTexture(this.gl.TEXTURE_2D,s),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.REPEAT),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.REPEAT),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,i);const a=this.gl.getUniformLocation(t,e);return this.gl.uniform1i(a,r),this.textures.push(s),s}setTextureWithArray16F(t,e,i,s,r){const a=this.gl.createTexture(),h=this.textures.length;this.gl.activeTexture(this.gl.TEXTURE0+h),this.gl.bindTexture(this.gl.TEXTURE_2D,a),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.REPEAT),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.REPEAT),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGB16F,i,s,0,this.gl.RGB,this.gl.FLOAT,r);const n=this.gl.getUniformLocation(t,e);return this.gl.uniform1i(n,h),this.textures.push(a),a}setTextureWithMIP(t,e,i){const s=this.gl.createTexture(),r=this.textures.length;this.gl.activeTexture(this.gl.TEXTURE0+r),this.gl.bindTexture(this.gl.TEXTURE_2D,s),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.REPEAT),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.REPEAT),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR_MIPMAP_LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,i),this.gl.generateMipmap(this.gl.TEXTURE_2D);const a=this.gl.getUniformLocation(t,e);return this.gl.uniform1i(a,r),this.textures.push(s),s}start(){this.resizeCanvasToDisplaySize(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.gl.createBuffer()),this.gl.bufferData(this.gl.ARRAY_BUFFER,new Float32Array([1,1,-1,1,1,-1,-1,-1]),this.gl.STATIC_DRAW),this.gl.enableVertexAttribArray(0),this.gl.vertexAttribPointer(0,2,this.gl.FLOAT,!1,0,0),this.framebuffers.forEach((t=>{this.gl.useProgram(t.program),t.onProgramInit(t)})),this.gl.useProgram(this.renderbufer.program),this.renderbufer.onProgramInit(this.renderbufer),this.startTime=this.currentTime=performance.now()/1e3,this.loop()}loop(){const t=performance.now()/1e3,e=t-this.startTime,i=t-this.currentTime;this.currentTime=t,this.onUpdate(e,i),this.framebuffers.forEach((t=>{this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,t.framebuffer),t.fbTextures.length>1&&this.gl.drawBuffers(t.fbTextures.map(((t,e)=>this.gl.COLOR_ATTACHMENT0+e))),this.gl.useProgram(t.program),null!==t.clearColor?(this.gl.clearColor(t.clearColor.x,t.clearColor.y,t.clearColor.z,t.clearColor.w),t.isDepthTest?this.gl.enable(this.gl.DEPTH_TEST):this.gl.disable(this.gl.DEPTH_TEST),this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT)):t.isDepthTest?(this.gl.enable(this.gl.DEPTH_TEST),this.gl.clear(this.gl.DEPTH_BUFFER_BIT)):this.gl.disable(this.gl.DEPTH_TEST),this.gl.bindVertexArray(t.vertexArray),this.gl.uniform2f(t.resolutionLocation,t.width,t.height),this.gl.uniform2f(t.timeLocation,e,i),this.gl.viewport(0,0,t.width,t.height),t.isElementDraw?this.gl.drawElements(this.gl.TRIANGLE_STRIP,t.numOfVertices,this.gl.UNSIGNED_INT,0):this.gl.drawArrays(this.gl.TRIANGLE_STRIP,0,t.numOfVertices),t.onProgramLoop(e,i)})),this.resizeCanvasToDisplaySize(),this.gl.disable(this.gl.DEPTH_TEST),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null),this.gl.useProgram(this.renderbufer.program),this.gl.bindVertexArray(this.renderbufer.vertexArray),this.gl.uniform2f(this.renderbufer.resolutionLocation,this.canvas.width,this.canvas.height),this.gl.uniform2f(this.renderbufer.timeLocation,e,i),this.gl.viewport(0,0,this.canvas.width,this.canvas.height),this.renderbufer.isElementDraw?this.gl.drawElements(this.gl.TRIANGLE_STRIP,this.renderbufer.numOfVertices,this.gl.UNSIGNED_INT,0):this.gl.drawArrays(this.gl.TRIANGLE_STRIP,0,this.renderbufer.numOfVertices),this.renderbufer.onProgramLoop(e,i),requestAnimationFrame(this.loop.bind(this))}}e.Engine=a},490:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.Flare=void 0;const s=i(193),r=i(421),a=i(921);e.Flare=class{constructor(t,e=new s.Vec3(100,100,100)){this.velocity=s.Vec3.ZERO(),this.initialSpeed=100,this.initialDirection=new s.Vec3(0,Math.sin((0,a.rad)(15)),-Math.cos((0,a.rad)(15))),this.isVisible=!1,this.g=9.81,this.n=0,this.camera=t,this.position=this.camera.position.copy(),this.light=e}update(t,e){if(this.isVisible){this.position.addMutable(this.velocity.mul(e)),this.velocity.addMutable(new s.Vec3(0,-this.g*e,0));const t=this.camera.tSampler.terrainM(new s.Vec2(this.position.x,this.position.z)),i=this.position.y-t;if(i<0){if(++this.n>0)return void(this.isVisible=!1);this.position.y-=i;const t=this.camera.tSampler.calcNormalM(this.position,200);this.velocity.addMutable(t.mul(-1.1*t.dot(this.velocity))).mulMutable(.6)}}else(0,r.isKeyPress)(70)>0&&(this.isVisible=!0,this.n=0,this.position=this.camera.position.add(this.camera.orientation.rotate(s.Vec3.I())),this.velocity=this.camera.velocity.add(this.camera.orientation.rotate(this.initialDirection).mul(this.initialSpeed)))}}},318:(t,e)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.GLContext=void 0,e.GLContext=class{constructor(t){if(void 0!==t){if(this.canvas=document.getElementById(t),void 0===this.canvas)throw new Error("Cannot find element named: "+t)}else this.canvas=document.createElement("canvas"),document.body.appendChild(this.canvas);if(this.gl=this.canvas.getContext("webgl2"),!this.gl)throw new Error("Unable to initialize WebGL. Your browser or machine may not support it.");this.gl.getExtension("EXT_color_buffer_float")}createShader(t,e){const i=this.gl.createShader(t);return this.gl.shaderSource(i,e.trim()),this.gl.compileShader(i),this.gl.getShaderParameter(i,this.gl.COMPILE_STATUS)?i:(alert("Error compiling shader: "+this.gl.getShaderInfoLog(i)),this.gl.deleteShader(i),null)}createProgram(t,e){const i=this.createShader(this.gl.VERTEX_SHADER,t),s=this.createShader(this.gl.FRAGMENT_SHADER,e),r=this.gl.createProgram();return this.gl.attachShader(r,i),this.gl.attachShader(r,s),this.gl.linkProgram(r),this.gl.getProgramParameter(r,this.gl.LINK_STATUS)?r:(alert("Unable to initialize the shader program: "+this.gl.getProgramInfoLog(r)),null)}createFramebuffer0(t,e){const i=this.gl.createFramebuffer();this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,i);const s=this.gl.createTexture();this.gl.bindTexture(this.gl.TEXTURE_2D,s),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA16F,t,e,0,this.gl.RGBA,this.gl.FLOAT,null),this.gl.texParameterf(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR),this.gl.texParameterf(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameterf(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),this.gl.framebufferTexture2D(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0,this.gl.TEXTURE_2D,s,0);const r=this.gl.createRenderbuffer();this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,r),this.gl.renderbufferStorage(this.gl.RENDERBUFFER,this.gl.DEPTH_COMPONENT16,t,e),this.gl.framebufferRenderbuffer(this.gl.FRAMEBUFFER,this.gl.DEPTH_ATTACHMENT,this.gl.RENDERBUFFER,r);const a=this.gl.checkFramebufferStatus(this.gl.FRAMEBUFFER);if(a!==this.gl.FRAMEBUFFER_COMPLETE)throw new Error("Framebuffer object is incomplete: "+a.toString());return[i,s]}createFramebufferMRT(t,e,i){const s=this.gl.createFramebuffer();this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,s);const r=[];for(let s=0;s<i;s++){const i=this.gl.createTexture();r.push(i),this.gl.bindTexture(this.gl.TEXTURE_2D,i),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA16F,t,e,0,this.gl.RGBA,this.gl.FLOAT,null),this.gl.texParameterf(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR),this.gl.texParameterf(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameterf(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),this.gl.framebufferTexture2D(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0+s,this.gl.TEXTURE_2D,i,0)}const a=this.gl.createRenderbuffer();this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,a),this.gl.renderbufferStorage(this.gl.RENDERBUFFER,this.gl.DEPTH_COMPONENT16,t,e),this.gl.framebufferRenderbuffer(this.gl.FRAMEBUFFER,this.gl.DEPTH_ATTACHMENT,this.gl.RENDERBUFFER,a);const h=this.gl.checkFramebufferStatus(this.gl.FRAMEBUFFER);if(h!==this.gl.FRAMEBUFFER_COMPLETE)throw new Error("Framebuffer object is incomplete: "+h.toString());return[s,r]}}},421:(t,e)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.isKeyDown=e.isKeyPress=e.initKeyBuffer=void 0;const i=256,s=Array(i).fill(0);function r(t){t.keyCode>=i||(s[t.keyCode]=1,t.preventDefault())}function a(t){t.keyCode>=i||(s[t.keyCode]=0,t.preventDefault())}e.initKeyBuffer=function(){window.addEventListener("keydown",r,!1),window.addEventListener("keyup",a,!1)},e.isKeyPress=function(t){const e=s[t];return s[t]=0,e},e.isKeyDown=function(t){return s[t]}},921:(t,e)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.rad=e.mix=e.smoothstep=void 0,e.smoothstep=function(t,e,i){if(i<=t)return 0;if(i>=e)return 1;const s=(i-t)/(e-t);return s*s*(3-2*s)},e.mix=function(t,e,i){return t+i*(e-t)},e.rad=function(t){return Math.PI*t/180}},100:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.NoiseSampler=void 0;const s=i(193);e.NoiseSampler=class{constructor(t){const e=document.createElement("canvas");e.width=t.width,e.height=t.height;const i=e.getContext("2d");i.drawImage(t,0,0,t.width,t.height),this._data=i.getImageData(0,0,e.width,e.height)}getSample(t){const e=t.fract(),i=Math.floor(e.x*this._data.width),s=Math.floor(e.y*this._data.height);return this._data.data[s*this._data.width+i<<2]/255}noiseD(t){const e=t.floor(),i=t.copy().subMutable(e),r=new s.Vec2(3,3).subMutable(i.mul(2)).mulElMutable(i).mulElMutable(i),a=new s.Vec2(1,1).subMutable(i).mulElMutable(i).mulMutable(6),h=this.getSample(new s.Vec2(.5,.5).addMutable(e).divMutable(256)),n=this.getSample(new s.Vec2(1.5,.5).addMutable(e).divMutable(256)),o=this.getSample(new s.Vec2(.5,1.5).addMutable(e).divMutable(256)),l=this.getSample(new s.Vec2(1.5,1.5).addMutable(e).divMutable(256));return{value:h+(n-h)*r.x+(o-h)*r.y+(h-n-o+l)*r.x*r.y,derivative:new s.Vec2(a.x*(r.y*(h-n-o+l)+n-h),a.y*(r.x*(h-n-o+l)+o-h))}}}},704:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.Quaternion=void 0;const s=i(193);class r extends s.Vec4{invert(){return new r(-this.x,-this.y,-this.z,this.w).divMutable(this.dot(this))}qmul(t){return new r(this.w*t.x+this.x*t.w+this.y*t.z-this.z*t.y,this.w*t.y+this.y*t.w+this.z*t.x-this.x*t.z,this.w*t.z+this.z*t.w+this.x*t.y-this.y*t.x,this.w*t.w-this.x*t.x-this.y*t.y-this.z*t.z)}rotate(t){const e=new r(t.x,t.y,t.z,0),i=this.qmul(e).qmul(this.invert());return new s.Vec3(i.x,i.y,i.z)}mat3(){return new s.Mat3(this.rotate(s.Vec3.I()),this.rotate(s.Vec3.J()),this.rotate(s.Vec3.K()))}static byAngle(t,e){const i=.5*e,s=t.mul(Math.sin(i));return new r(s.x,s.y,s.z,Math.cos(i))}static byYawPitchRoll(t,e,i){return r.byAngle(s.Vec3.I(),e).qmul(r.byAngle(s.Vec3.J(),t).qmul(r.byAngle(s.Vec3.K(),i)))}}e.Quaternion=r,r.Identity=()=>new r(0,0,0,1)},240:(t,e)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.preprocess=void 0,e.preprocess=async function t(e,i,s=0){if(s>10)throw new Error("Превышено возможное количество уровней вложения модулей программы");const r=(await async function(t){let e=await fetch(t);return await e.text()}(e+"/"+i)).split("\n").map((async i=>{if(i.startsWith("#include")){const[r,a]=i.split(/\s/,2);return await t(e,a.replace(/["']/g,""),s+1)}return i}));return(await Promise.all(r)).join("\n")}},385:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.Sky=void 0;const s=i(704),r=i(193),a=i(421),h=i(24),n=.12*Math.PI;e.Sky=class{constructor(t,e){this.quat=s.Quaternion.byAngle(r.Vec3.I(),.5*Math.PI),this.axis=new r.Vec3(0,Math.cos(n),-Math.sin(n)),this.period=1200,this.sunDir=new r.Vec3(0,-Math.sin(n),-Math.cos(n)),this.orientation=s.Quaternion.Identity(),this.transformMat=r.Mat3.ID(),this.isShowConstellations=!1,this.sunDirection=this.sunDir.copy(),this.skyRefreshTime=0,this.sunDiscColor=r.Vec3.ZERO(),this.skyColor=r.Vec3.ZERO(),this.camera=t,this.atm=e}loopCalculation(t,e){if(this.orientation=s.Quaternion.byAngle(this.axis,-2*Math.PI*(.25+t/this.period)),this.transformMat=this.orientation.qmul(this.quat).mat3(),this.sunDirection=this.orientation.rotate(this.sunDir).normalize(),(0,a.isKeyPress)(67)>0&&(this.isShowConstellations=!this.isShowConstellations),t>this.skyRefreshTime){const e=new r.Vec3(this.camera.position.x,0,this.camera.position.z),i=this.sunDirection.copy();i.y<0&&(i.y=0),i.normalizeMutable();const s=this.atm.scattering(e,i,i),a=h.SUN_COLOR.mul(20);this.sunDiscColor=a.mulEl(s.t).safeNormalize().mulMutable(2);const n=1/Math.sqrt(2),o=this.atm.scattering(e,r.Vec3.J(),this.sunDirection).t.add(this.atm.scattering(e,new r.Vec3(n,n,0),this.sunDirection).t).add(this.atm.scattering(e,new r.Vec3(-n,n,0),this.sunDirection).t).add(this.atm.scattering(e,new r.Vec3(0,n,n),this.sunDirection).t).add(this.atm.scattering(e,new r.Vec3(0,n,-n),this.sunDirection).t).div(5);this.skyColor=a.mulEl(o),this.skyRefreshTime=t+.5}}}},270:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.TerrainSampler=void 0;const s=i(24),r=i(921),a=i(193),h=new a.Mat2(new a.Vec2(.8,-.6),new a.Vec2(.6,.8)),n=3e3,o=1100;e.TerrainSampler=class{constructor(t){this._noiseSampler=t}terrainH(t){let e=t.div(n),i=0,s=1;const r=a.Vec2.ZERO();for(let t=0;t<16;t++){const t=this._noiseSampler.noiseD(e);r.addMutable(t.derivative),i+=s*t.value/(1+r.dot(r)),s*=.5,e=h.mul(e.add(e))}return o*i}terrainM(t){let e=t.div(n),i=0,s=1;const r=a.Vec2.ZERO();for(let t=0;t<9;t++){const t=this._noiseSampler.noiseD(e);r.addMutable(t.derivative),i+=s*t.value/(1+r.dot(r)),s*=.5,e=h.mul(e.add(e))}return o*i}terrainS(t){let e=t.div(n),i=0,s=1;const r=a.Vec2.ZERO();for(let t=0;t<5;t++){const t=this._noiseSampler.noiseD(e);r.addMutable(t.derivative),i+=s*t.value/(1+r.dot(r)),s*=.5,e=h.mul(e.add(e))}return o*i}calcNormalM(t,e){const i=new a.Vec2(.001*e,0);return new a.Vec3(this.terrainM(new a.Vec2(t.x-i.x,t.z-i.y))-this.terrainM(new a.Vec2(t.x+i.x,t.z+i.y)),2*i.x,this.terrainM(new a.Vec2(t.x-i.y,t.z-i.x))-this.terrainM(new a.Vec2(t.x+i.y,t.z+i.x))).normalize()}softShadow(t,e){let i=1,h=.1;const n=Math.sqrt(1-e.z*e.z);for(let o=0;o<200;o++){const o=t.add(e.mul(h));if(o.y>1980)return(0,r.smoothstep)(-s.SUN_DISC_ANGLE_SIN,s.SUN_DISC_ANGLE_SIN,i);const l=o.y-this.terrainM(new a.Vec2(o.x,o.z));if(i=Math.min(i,n*l/h),i<-s.SUN_DISC_ANGLE_SIN)return(0,r.smoothstep)(-s.SUN_DISC_ANGLE_SIN,s.SUN_DISC_ANGLE_SIN,i);h+=Math.max(1,.6*Math.abs(l))}return 0}}},193:(t,e)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.Mat2=e.Vec2=e.Mat3=e.Vec3=e.Mat4=e.Vec4=void 0;class i{constructor(t,e,i,s){this.x=t,this.y=e,this.z=i,this.w=s}addMutable(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this.w+=t.w,this}subMutable(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this.w-=t.w,this}mulMutable(t){return this.x*=t,this.y*=t,this.z*=t,this.w*=t,this}divMutable(t){return this.x/=t,this.y/=t,this.z/=t,this.w/=t,this}mulElMutable(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this.w*=t.w,this}divElMutable(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this.w/=t.w,this}normalizeMutable(){return this.divMutable(Math.sqrt(this.dot(this)))}add(t){return this.copy().addMutable(t)}sub(t){return this.copy().subMutable(t)}mul(t){return this.copy().mulMutable(t)}div(t){return this.copy().divMutable(t)}mulEl(t){return this.copy().mulElMutable(t)}divEl(t){return this.copy().divElMutable(t)}normalize(){return this.copy().normalizeMutable()}length(){return Math.sqrt(this.dot(this))}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z+this.w*t.w}copy(){return new i(this.x,this.y,this.z,this.w)}floor(){return new i(Math.floor(this.x),Math.floor(this.y),Math.floor(this.z),Math.floor(this.w))}fract(){return this.copy().subMutable(this.floor())}getArray(){return[this.x,this.y,this.z,this.w]}}e.Vec4=i,i.ZERO=()=>new i(0,0,0,0),i.ONE=()=>new i(1,1,1,1),i.I=()=>new i(1,0,0,0),i.J=()=>new i(0,1,0,0),i.K=()=>new i(0,0,1,0),i.L=()=>new i(0,0,0,1);class s{constructor(t,e,i,s){this.i=t.copy(),this.j=e.copy(),this.k=i.copy(),this.l=s.copy()}mulLeft(t){return new i(this.i.dot(t),this.j.dot(t),this.k.dot(t),this.l.dot(t))}mul(t){return new i(t.x*this.i.x+t.y*this.j.x+t.z*this.k.x+t.w*this.l.x,t.x*this.i.y+t.y*this.j.y+t.z*this.k.y+t.w*this.l.y,t.x*this.i.z+t.y*this.j.z+t.z*this.k.z+t.w*this.l.z,t.x*this.i.w+t.y*this.j.w+t.z*this.k.w+t.w*this.l.w)}getArray(){return[this.i.x,this.i.y,this.i.z,this.i.w,this.j.x,this.j.y,this.j.z,this.j.w,this.k.x,this.k.y,this.k.z,this.k.w,this.l.x,this.l.y,this.l.z,this.l.w]}static orthoProjectMatrix(t,e,r,a,h,n){return new s(new i(2/(e-t),0,0,-(e+t)/(e-t)),new i(0,2/(a-r),0,-(a+r)/(a-r)),new i(0,0,-2/(n-h),-(n+h)/(n-h)),new i(0,0,0,1))}static perspectiveProjectMatrix(t,e,r,a){return new s(new i(1/Math.tan(.5*t),0,0,0),new i(0,e/Math.tan(.5*t),0,0),new i(0,0,-(a+r)/(a-r),-2*a*r/(a-r)),new i(0,0,-1,0))}}e.Mat4=s,s.ID=()=>new s(i.I(),i.J(),i.K(),i.L()),s.ZERO=()=>new s(i.ZERO(),i.ZERO(),i.ZERO(),i.ZERO());class r{constructor(t,e,i){this.x=t,this.y=e,this.z=i}addMutable(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this}subMutable(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this}mulMutable(t){return this.x*=t,this.y*=t,this.z*=t,this}divMutable(t){return this.x/=t,this.y/=t,this.z/=t,this}mulElMutable(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this}divElMutable(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this}normalizeMutable(){return this.divMutable(Math.sqrt(this.dot(this)))}safeNormalize(){const t=Math.sqrt(this.dot(this));return t<Number.MIN_VALUE?r.ZERO():this.div(t)}colorNormalize(){const t=Math.max(this.x,this.y,this.z);return t<Number.MIN_VALUE?r.ZERO():this.div(t)}add(t){return this.copy().addMutable(t)}sub(t){return this.copy().subMutable(t)}mul(t){return this.copy().mulMutable(t)}div(t){return this.copy().divMutable(t)}mulEl(t){return this.copy().mulElMutable(t)}divEl(t){return this.copy().divElMutable(t)}normalize(){return this.copy().normalizeMutable()}length(){return Math.sqrt(this.dot(this))}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z}copy(){return new r(this.x,this.y,this.z)}floor(){return new r(Math.floor(this.x),Math.floor(this.y),Math.floor(this.z))}fract(){return this.copy().subMutable(this.floor())}exp(){return new r(Math.exp(this.x),Math.exp(this.y),Math.exp(this.z))}getArray(){return[this.x,this.y,this.z]}cross(t){return new r(this.y*t.z-this.z*t.y,this.z*t.x-this.x*t.z,this.x*t.y-this.y*t.x)}}e.Vec3=r,r.ZERO=()=>new r(0,0,0),r.ONE=()=>new r(1,1,1),r.I=()=>new r(1,0,0),r.J=()=>new r(0,1,0),r.K=()=>new r(0,0,1);class a{constructor(t,e,i){this.i=t.copy(),this.j=e.copy(),this.k=i.copy()}mulLeft(t){return new r(this.i.dot(t),this.j.dot(t),this.k.dot(t))}mul(t){return new r(t.x*this.i.x+t.y*this.j.x+t.z*this.k.x,t.x*this.i.y+t.y*this.j.y+t.z*this.k.y,t.x*this.i.z+t.y*this.j.z+t.z*this.k.z)}getArray(){return[this.i.x,this.i.y,this.i.z,this.j.x,this.j.y,this.j.z,this.k.x,this.k.y,this.k.z]}}e.Mat3=a,a.ID=()=>new a(r.I(),r.J(),r.K()),a.ZERO=()=>new a(r.ZERO(),r.ZERO(),r.ZERO());class h{constructor(t,e){this.x=t,this.y=e}addMutable(t){return this.x+=t.x,this.y+=t.y,this}subMutable(t){return this.x-=t.x,this.y-=t.y,this}mulMutable(t){return this.x*=t,this.y*=t,this}divMutable(t){return this.x/=t,this.y/=t,this}mulElMutable(t){return this.x*=t.x,this.y*=t.y,this}divElMutable(t){return this.x/=t.x,this.y/=t.y,this}normalizeMutable(){return this.divMutable(Math.sqrt(this.dot(this)))}add(t){return this.copy().addMutable(t)}sub(t){return this.copy().subMutable(t)}mul(t){return this.copy().mulMutable(t)}div(t){return this.copy().divMutable(t)}mulEl(t){return this.copy().mulElMutable(t)}divEl(t){return this.copy().divElMutable(t)}normalize(){return this.copy().normalizeMutable()}length(){return Math.sqrt(this.dot(this))}dot(t){return this.x*t.x+this.y*t.y}copy(){return new h(this.x,this.y)}floor(){return new h(Math.floor(this.x),Math.floor(this.y))}fract(){return this.copy().subMutable(this.floor())}getArray(){return[this.x,this.y]}cross(t){return this.x*t.y-this.y*t.x}}e.Vec2=h,h.ZERO=()=>new h(0,0),h.ONE=()=>new h(1,1),h.I=()=>new h(1,0),h.J=()=>new h(0,1);class n{constructor(t,e){this.i=t.copy(),this.j=e.copy()}mulLeft(t){return new h(this.i.dot(t),this.j.dot(t))}mul(t){return new h(t.x*this.i.x+t.y*this.j.x,t.x*this.i.y+t.y*this.j.y)}getArray(){return[this.i.x,this.i.y,this.j.x,this.j.y]}}e.Mat2=n,n.ID=()=>new n(h.I(),h.J()),n.ZERO=()=>new n(h.ZERO(),h.ZERO())},237:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.ProgramA=void 0;const s=i(193);e.ProgramA=class{constructor(t,e,i){this.numX=960,this.numY=480,this.engine=t,this.bufferInput=e,this.camera=i}init(t){this.engine.setRenderedTexture(t.program,this.bufferInput.fbTextures[0],"uTextureProgramB");const e=this.engine.gl.getUniformLocation(t.program,"uTextureBResolution");this.engine.gl.uniform2f(e,this.bufferInput.width,this.bufferInput.height);const i=this.engine.gl.getUniformLocation(t.program,"uNetResolution");this.engine.gl.uniform2f(i,this.numX,this.numY),this.uProjectMatrix=this.engine.gl.getUniformLocation(t.program,"uProjectMatrix"),this.uTransformMatrix=this.engine.gl.getUniformLocation(t.program,"uTransformMatrix"),this.uTransformMatrixPrev=this.engine.gl.getUniformLocation(t.program,"uTransformMatrixPrev"),this.uPositionDelta=this.engine.gl.getUniformLocation(t.program,"uPositionDelta"),this.uCameraViewAngle=this.engine.gl.getUniformLocation(t.program,"uCameraViewAngle");const r=[];for(let t=0;t<this.numY+1;t++)for(let e=0;e<this.numX+1;e++)r.push(2*e/this.numX-1),r.push(1-2*t/this.numY);const a=[];for(let t=0;t<this.numY;t++){for(let e=0;e<this.numX+1;e++)a.push(e+t*(this.numX+1)),a.push(e+(t+1)*(this.numX+1));if(t++,t>=this.numY)break;for(let e=this.numX;e>=0;e--)a.push(e+t*(this.numX+1)),a.push(e+(t+1)*(this.numX+1))}this.engine.setVertexArray(t,"aVertexPosition",r,a,2),t.clearColor=new s.Vec4(0,0,0,0),t.isDepthTest=!0}update(){const t=this.bufferInput.width/this.bufferInput.height;this.engine.gl.uniformMatrix4fv(this.uProjectMatrix,!1,s.Mat4.perspectiveProjectMatrix(this.camera.viewAngle,t,.5,65e3).getArray()),this.engine.gl.uniformMatrix3fv(this.uTransformMatrixPrev,!1,this.camera.transformMatPrev.getArray()),this.engine.gl.uniformMatrix3fv(this.uTransformMatrix,!1,this.camera.transformMat.getArray()),this.engine.gl.uniform3fv(this.uPositionDelta,this.camera.positionDelta.getArray()),this.engine.gl.uniform1f(this.uCameraViewAngle,this.camera.viewAngle)}}},386:(t,e)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.ProgramB=void 0,e.ProgramB=class{constructor(t,e,i,s){this.engine=t,this.bufferInput=e,this.camera=i,this.atm=s}init(t,e){this.engine.setTextureWithMIP(t.program,"uTextureGrayNoise",e),this.engine.setRenderedTexture(t.program,this.bufferInput.fbTextures[0],"uTextureProgramA");const i=this.engine.gl.getUniformLocation(t.program,"uTextureAResolution");this.engine.gl.uniform2f(i,this.bufferInput.width,this.bufferInput.height),this.uCameraPosition=this.engine.gl.getUniformLocation(t.program,"uCameraPosition"),this.uCameraViewAngle=this.engine.gl.getUniformLocation(t.program,"uCameraViewAngle"),this.uCameraDirection=this.engine.gl.getUniformLocation(t.program,"uCameraDirection"),this.uTransformMat=this.engine.gl.getUniformLocation(t.program,"uTransformMat"),this.uPlanetRadius=this.engine.gl.getUniformLocation(t.program,"uPlanetRadius"),this.engine.gl.uniform1f(this.uPlanetRadius,this.atm.planetRadius),this.uPlanetCenter=this.engine.gl.getUniformLocation(t.program,"uPlanetCenter"),this.engine.gl.uniform3fv(this.uPlanetCenter,this.atm.planetCenter.getArray()),this.uScreenMode=this.engine.gl.getUniformLocation(t.program,"uScreenMode"),this.uMapScale=this.engine.gl.getUniformLocation(t.program,"uMapScale")}update(t,e){this.engine.gl.uniform3fv(this.uCameraPosition,this.camera.position.getArray()),this.engine.gl.uniform3fv(this.uCameraDirection,this.camera.direction.getArray()),this.engine.gl.uniformMatrix3fv(this.uTransformMat,!1,this.camera.transformMat.getArray()),this.engine.gl.uniform1f(this.uCameraViewAngle,this.camera.viewAngle),this.engine.gl.uniform2f(this.uScreenMode,this.camera.screenMode,this.camera.mapMode),this.engine.gl.uniform1f(this.uMapScale,this.camera.mapScale)}}},9:(t,e,i)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.ProgramRender=void 0;const s=i(193),r=i(764),a=i(24),h=i(921);e.ProgramRender=class{constructor(t,e,i,r,a,n,o,l){this.skyRefreshTime=0,this.numSSAOSamples=32,this.SSAOSamples=[],this.SSAONoise=[],this.numOfFlares=2,this.engine=t,this.shaderA=e,this.shaderB=i,this.camera=r,this.atm=a,this.sky=n,this.flare1=o,this.flare2=l;for(let t=0;t<this.numSSAOSamples;t++){let e=t/this.numSSAOSamples;e=(0,h.mix)(.1,1,e*e),this.SSAOSamples.push(new s.Vec3(2*Math.random()-1,2*Math.random()-1,Math.random()).normalizeMutable().mulMutable(e))}for(let t=0;t<16;t++)this.SSAONoise.push(new s.Vec3(2*Math.random()-1,2*Math.random()-1,0))}init(t,e,i,s,r){this.engine.setRenderedTexture(t.program,this.shaderA.fbTextures[0],"uTextureProgramA"),this.engine.setRenderedTexture(t.program,this.shaderB.fbTextures[0],"uNormalDepthProgramB"),this.engine.setRenderedTexture(t.program,this.shaderB.fbTextures[1],"uAlbedoProgramB"),this.engine.setRenderedTexture(t.program,this.shaderB.fbTextures[2],"uPositionProgramB"),this.engine.setTextureWithMIP(t.program,"uTextureGrayNoise",r);const h=this.shaderB.width,n=this.shaderB.height,o=this.engine.gl.getUniformLocation(t.program,"uTextureBResolution");this.engine.gl.uniform2f(o,h,n);const l=[];this.SSAONoise.forEach((t=>l.push(...t.getArray()))),this.engine.setTextureWithArray16F(t.program,"uTextureSSAONoise",4,4,new Float32Array(l)),this.engine.setTexture(t.program,"uTextureBlueNoise",e),this.engine.setTexture(t.program,"uTextureMilkyway",i),this.engine.setTexture(t.program,"uTextureConstellation",s),this.uSSAOSamples=this.engine.gl.getUniformLocation(t.program,"uSSAOSamples");const u=[];this.SSAOSamples.forEach((t=>u.push(...t.getArray()))),this.engine.gl.uniform3fv(this.uSSAOSamples,u),this.uCameraPosition=this.engine.gl.getUniformLocation(t.program,"uCameraPosition"),this.uCameraViewAngle=this.engine.gl.getUniformLocation(t.program,"uCameraViewAngle"),this.uTransformMat=this.engine.gl.getUniformLocation(t.program,"uTransformMat"),this.uCameraInShadow=this.engine.gl.getUniformLocation(t.program,"uCameraInShadow"),this.uSkyColor=this.engine.gl.getUniformLocation(t.program,"uSkyColor"),this.uSunDirection=this.engine.gl.getUniformLocation(t.program,"uSunDirection"),this.uSunDiscColor=this.engine.gl.getUniformLocation(t.program,"uSunDiscColor"),this.uSunDiscAngleSin=this.engine.gl.getUniformLocation(t.program,"uSunDiscAngleSin"),this.engine.gl.uniform1f(this.uSunDiscAngleSin,a.SUN_DISC_ANGLE_SIN),this.uBetaRayleigh=this.engine.gl.getUniformLocation(t.program,"uBetaRayleigh"),this.engine.gl.uniform3fv(this.uBetaRayleigh,this.atm.betaRayleigh.getArray()),this.uBetaMie=this.engine.gl.getUniformLocation(t.program,"uBetaMie"),this.engine.gl.uniform3fv(this.uBetaMie,this.atm.betaMie.getArray()),this.uGMie=this.engine.gl.getUniformLocation(t.program,"uGMie"),this.engine.gl.uniform1f(this.uGMie,this.atm.g),this.uScaleHeight=this.engine.gl.getUniformLocation(t.program,"uScaleHeight"),this.engine.gl.uniform2f(this.uScaleHeight,this.atm.heightRayleigh,this.atm.heightMie),this.uAtmRadius=this.engine.gl.getUniformLocation(t.program,"uAtmRadius"),this.engine.gl.uniform1f(this.uAtmRadius,this.atm.radius),this.uPlanetRadius=this.engine.gl.getUniformLocation(t.program,"uPlanetRadius"),this.engine.gl.uniform1f(this.uPlanetRadius,this.atm.planetRadius),this.uPlanetCenter=this.engine.gl.getUniformLocation(t.program,"uPlanetCenter"),this.engine.gl.uniform3fv(this.uPlanetCenter,this.atm.planetCenter.getArray()),this.uSkyTransformMat=this.engine.gl.getUniformLocation(t.program,"uSkyTransformMat"),this.uConstellationsColor=this.engine.gl.getUniformLocation(t.program,"uConstellationsColor"),this.uHeadLight=this.engine.gl.getUniformLocation(t.program,"uHeadLight"),this.uFlarePositions=this.engine.gl.getUniformLocation(t.program,"uFlarePositions"),this.uFlareLights=this.engine.gl.getUniformLocation(t.program,"uFlareLights"),this.uScreenMode=this.engine.gl.getUniformLocation(t.program,"uScreenMode"),this.uMapScale=this.engine.gl.getUniformLocation(t.program,"uMapScale")}update(t,e){this.engine.gl.uniform3fv(this.uCameraPosition,this.camera.position.getArray()),this.engine.gl.uniform1f(this.uCameraViewAngle,this.camera.viewAngle),this.engine.gl.uniformMatrix3fv(this.uTransformMat,!1,this.camera.transformMat.getArray()),this.engine.gl.uniformMatrix3fv(this.uSkyTransformMat,!1,this.sky.transformMat.getArray()),this.engine.gl.uniform1f(this.uConstellationsColor,this.sky.isShowConstellations?1:0);const i=this.camera.screenMode!=r.FRONT_VIEW?0:this.camera.inShadow(this.atm,this.camera.position,this.sky.sunDirection);this.engine.gl.uniform1f(this.uCameraInShadow,i),this.engine.gl.uniform3fv(this.uSunDiscColor,this.sky.sunDiscColor.getArray()),this.engine.gl.uniform3f(this.uHeadLight,this.camera.headLights,this.camera.headLights,this.camera.headLights),this.engine.gl.uniform3fv(this.uSunDirection,this.sky.sunDirection.getArray()),this.engine.gl.uniform3fv(this.uSunDiscColor,this.sky.sunDiscColor.getArray()),this.engine.gl.uniform3fv(this.uSkyColor,this.sky.skyColor.getArray());const a=[...this.flare1.position.getArray(),...this.flare2.position.getArray()];this.engine.gl.uniform3fv(this.uFlarePositions,a);const h=[this.flare1.isVisible?this.flare1.light:s.Vec3.ZERO(),this.flare2.isVisible?this.flare2.light:s.Vec3.ZERO()];this.engine.gl.uniform3fv(this.uFlareLights,[...h[0].getArray(),...h[1].getArray()]),this.engine.gl.uniform2f(this.uScreenMode,this.camera.screenMode,this.camera.mapMode),this.engine.gl.uniform1f(this.uMapScale,this.camera.mapScale)}}},460:(t,e)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.loadImage=void 0,e.loadImage=function(t){return new Promise(((e,i)=>{const s=new Image;s.onload=()=>e(s),s.onerror=()=>i(),s.src=t}))}}},e={};(0,function i(s){var r=e[s];if(void 0!==r)return r.exports;var a=e[s]={exports:{}};return t[s](a,a.exports,i),a.exports}(752).Z)()})();